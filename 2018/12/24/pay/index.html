<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: 'UJCQ3PDF0F',
      apiKey: 'a3d4ab7cd60617bd0d524169bb08d56d',
      indexName: 'dev_ayanamiq',
      hits: {"per_page":10},
      labels: {"input_placeholder":"输入关键字","hits_empty":"没有找到关于 ${query} 的文章","hits_stats":"${hits} 相关记录，共耗时 ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="支付宝支付官网：https://docs.open.alipay.com/catalog微信支付官网：https://pay.weixin.qq.com/wiki/doc/api/index.html 设计思路策略模式+工厂模式，工厂方法用于创建不同场景下的策略。类图如下：策略接口IPayStrategy定义了需要子类实现的方法 ，每一种支付方式为一种策略。场景类通过枚举类获取策略类型，通过Pay">
<meta name="keywords" content="pay">
<meta property="og:type" content="article">
<meta property="og:title" content="pay">
<meta property="og:url" content="http://ayanamiq.github.io/2018/12/24/pay/index.html">
<meta property="og:site_name" content="王靖尧的博客">
<meta property="og:description" content="支付宝支付官网：https://docs.open.alipay.com/catalog微信支付官网：https://pay.weixin.qq.com/wiki/doc/api/index.html 设计思路策略模式+工厂模式，工厂方法用于创建不同场景下的策略。类图如下：策略接口IPayStrategy定义了需要子类实现的方法 ，每一种支付方式为一种策略。场景类通过枚举类获取策略类型，通过Pay">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://ayanamiq.github.io/2018/12/24/pay/1.jpg">
<meta property="og:image" content="http://ayanamiq.github.io/2018/12/24/pay/2.jpg">
<meta property="og:updated_time" content="2019-05-17T09:42:08.684Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pay">
<meta name="twitter:description" content="支付宝支付官网：https://docs.open.alipay.com/catalog微信支付官网：https://pay.weixin.qq.com/wiki/doc/api/index.html 设计思路策略模式+工厂模式，工厂方法用于创建不同场景下的策略。类图如下：策略接口IPayStrategy定义了需要子类实现的方法 ，每一种支付方式为一种策略。场景类通过枚举类获取策略类型，通过Pay">
<meta name="twitter:image" content="http://ayanamiq.github.io/2018/12/24/pay/1.jpg">





  
  
  <link rel="canonical" href="http://ayanamiq.github.io/2018/12/24/pay/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>pay | 王靖尧的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">王靖尧的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://ayanamiq.github.io/2018/12/24/pay/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王靖尧">
      <meta itemprop="description" content="一晃而过的时间，都做了些什么">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王靖尧的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">pay

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-24 13:50:44" itemprop="dateCreated datePublished" datetime="2018-12-24T13:50:44+08:00">2018-12-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-17 17:42:08" itemprop="dateModified" datetime="2019-05-17T17:42:08+08:00">2019-05-17</time>
              
            
          </span>

          

          
            
            
          

          
          
            <span id="/2018/12/24/pay/" class="leancloud_visitors" data-flag-title="pay">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">阅读次数：</span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>支付宝支付官网：<br><a href="https://docs.open.alipay.com/catalog" target="_blank" rel="noopener">https://docs.open.alipay.com/catalog</a><br>微信支付官网：<br><a href="https://pay.weixin.qq.com/wiki/doc/api/index.html" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/index.html</a></p>
<h1 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h1><p>策略模式+工厂模式，工厂方法用于创建不同场景下的策略。类图如下：<br><img src="/2018/12/24/pay/1.jpg" alt=""><br>策略接口<code>IPayStrategy</code>定义了需要子类实现的方法 ，每一种支付方式为一种策略。<br>场景类通过枚举类获取策略类型，通过PayFactory创建场景类需要的支付策略。<br>工厂方法可以创建默认商户的支付策略，也可以在工厂方法里再写一个使用指定商户id或第三方支付的沙箱环境的方法 ，payBaseModel为一些业务参数，例如标题，描述，回调接口以及支付完的跳转页面等。</p>
<h1 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.52.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.wxpay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wxpay-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>由于微信最新的支付sdk在maven仓库里已经没有，合并为了weixin-java-tools里的一个模块，详见<br><a href="https://github.com/wechat-group/WxJava" target="_blank" rel="noopener">https://github.com/wechat-group/WxJava</a><br>本文所使用的微信支付sdk是官网下载后自己编译的。</p>
<h1 id="关键类"><a href="#关键类" class="headerlink" title="关键类"></a>关键类</h1><h2 id="策略接口"><a href="#策略接口" class="headerlink" title="策略接口"></a>策略接口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface IPayStrategy &#123;</span><br><span class="line">    public Map&lt;String,String&gt; excutePayOrder(PayBaseModel model) throws Exception;</span><br><span class="line">    public int excuteQueryStatus(String orderNo) throws Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="业务参数类"><a href="#业务参数类" class="headerlink" title="业务参数类"></a>业务参数类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayBaseModel</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//商品标题</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">//商品描述</span></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="comment">//回调地址</span></span><br><span class="line">    <span class="keyword">private</span> String notifyUrl;</span><br><span class="line">    <span class="comment">//交易金额</span></span><br><span class="line">    <span class="keyword">private</span> String tradeMoney;</span><br><span class="line">    <span class="comment">//商户订单号</span></span><br><span class="line">    <span class="keyword">private</span> String outTradeNo;</span><br><span class="line">    <span class="comment">//自定义参数</span></span><br><span class="line">    <span class="keyword">private</span> String attach;</span><br><span class="line">    <span class="comment">//网页支付完成后的跳转地址</span></span><br><span class="line">    <span class="keyword">private</span> String returnUrl;</span><br><span class="line">    <span class="comment">//用户ip</span></span><br><span class="line">    <span class="keyword">private</span> String realIp;</span><br><span class="line">    <span class="comment">//请求头</span></span><br><span class="line">    <span class="keyword">private</span> String referer;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//get set方法自己实现 也可以不用实现，因为构造函数里传入了</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PayBaseModel</span><span class="params">(String title, String notifyUrl, String tradeMoney, String outTradeNo, String returnUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">        <span class="keyword">this</span>.notifyUrl = notifyUrl;</span><br><span class="line">        <span class="keyword">this</span>.tradeMoney = tradeMoney;</span><br><span class="line">        <span class="keyword">this</span>.outTradeNo = outTradeNo;</span><br><span class="line">        <span class="keyword">this</span>.returnUrl = returnUrl;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PayBaseModel</span><span class="params">(String title, String notifyUrl, String tradeMoney, String outTradeNo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">        <span class="keyword">this</span>.notifyUrl = notifyUrl;</span><br><span class="line">        <span class="keyword">this</span>.tradeMoney = tradeMoney;</span><br><span class="line">        <span class="keyword">this</span>.outTradeNo = outTradeNo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="四种支付策略"><a href="#四种支付策略" class="headerlink" title="四种支付策略"></a>四种支付策略</h2><h3 id="AliAppPayStrategy"><a href="#AliAppPayStrategy" class="headerlink" title="AliAppPayStrategy"></a>AliAppPayStrategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayApiException;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayResponse;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.DefaultAlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.domain.AlipayTradeAppPayModel;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.request.AlipayTradeAppPayRequest;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.IPayStrategy;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.PayConstant;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.model.PayBaseModel;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.text.DecimalFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//支付宝APP支付</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliAppPayStrategy</span> <span class="keyword">implements</span> <span class="title">IPayStrategy</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String privateKey;</span><br><span class="line">    <span class="keyword">private</span> String publicKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderTimeOUt;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(AliAppPayStrategy.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AliAppPayStrategy</span><span class="params">(String url, String appId, String privateKey, String publicKey, <span class="keyword">int</span> orderTimeOUt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.appId = appId;</span><br><span class="line">        <span class="keyword">this</span>.privateKey = privateKey;</span><br><span class="line">        <span class="keyword">this</span>.publicKey = publicKey;</span><br><span class="line">        <span class="keyword">this</span>.orderTimeOUt = orderTimeOUt;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">excutePayOrder</span><span class="params">(PayBaseModel payBaseModel)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line">        LOGGER.info(<span class="string">"**********************获取支付宝APP支付模板"</span> + payBaseModel.toString()</span><br><span class="line">                + <span class="string">"**************************************************"</span>);</span><br><span class="line">        Map&lt;String, String&gt; resultMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        AlipayTradeAppPayRequest payRequest = <span class="keyword">new</span> AlipayTradeAppPayRequest();</span><br><span class="line">        AlipayTradeAppPayModel model = <span class="keyword">new</span> AlipayTradeAppPayModel();</span><br><span class="line">        <span class="comment">//组装必填参数：订单标题 商家交易订单号 交易金额</span></span><br><span class="line">        model.setSubject(payBaseModel.getTitle());</span><br><span class="line">        model.setOutTradeNo(payBaseModel.getOutTradeNo());</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(payBaseModel.getDesc())) &#123;</span><br><span class="line">            <span class="comment">//交易详情</span></span><br><span class="line">            model.setBody(payBaseModel.getDesc());</span><br><span class="line">        &#125;</span><br><span class="line">        model.setTotalAmount(<span class="keyword">new</span> DecimalFormat(<span class="string">"0.00"</span>).format(<span class="keyword">new</span> BigDecimal(payBaseModel.getTradeMoney())));</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(payBaseModel.getAttach())) &#123;</span><br><span class="line">            <span class="comment">//自定义参数</span></span><br><span class="line">            model.setPassbackParams(payBaseModel.getAttach());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//非必填参数 订单过期时间</span></span><br><span class="line">        model.setTimeoutExpress(<span class="keyword">this</span>.orderTimeOUt + <span class="string">"m"</span>);</span><br><span class="line">        <span class="comment">//app支付交易码-固定值</span></span><br><span class="line">        model.setProductCode(<span class="string">"QUICK_MSECURITY_PAY"</span>);</span><br><span class="line">        <span class="comment">//回调通知</span></span><br><span class="line">        payRequest.setNotifyUrl(payBaseModel.getNotifyUrl());</span><br><span class="line">        <span class="comment">//业务参数模板</span></span><br><span class="line">        payRequest.setBizModel(model);</span><br><span class="line">        AlipayClient alipayClient = <span class="keyword">new</span> DefaultAlipayClient(<span class="keyword">this</span>.url, <span class="keyword">this</span>.appId, <span class="keyword">this</span>.privateKey,</span><br><span class="line">                PayConstant.ALI_DEFAULT_FORMAT, PayConstant.DEFAULT_CHARSET, <span class="keyword">this</span>.publicKey, PayConstant.ALI_DEFAULT_SIGNTYPE);</span><br><span class="line">        AlipayResponse response = alipayClient.sdkExecute(payRequest);</span><br><span class="line">        resultMap.put(<span class="string">"payContent"</span>, response.getBody());</span><br><span class="line">        resultMap.put(<span class="string">"out_trade_no"</span>, payBaseModel.getOutTradeNo());</span><br><span class="line">        LOGGER.info(<span class="string">"**********************阿里支付下单接口返回数据:"</span> + resultMap + <span class="string">"**************************************************"</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AliWebPayStrategy"><a href="#AliWebPayStrategy" class="headerlink" title="AliWebPayStrategy"></a>AliWebPayStrategy</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.alipay.api.AlipayApiException;</span><br><span class="line">import com.alipay.api.AlipayClient;</span><br><span class="line">import com.alipay.api.DefaultAlipayClient;</span><br><span class="line">import com.alipay.api.request.AlipayTradeWapPayRequest;</span><br><span class="line">import com.tubitu.util.pay.IPayStrategy;</span><br><span class="line">import com.tubitu.util.pay.PayConstant;</span><br><span class="line">import com.tubitu.util.pay.model.PayBaseModel;</span><br><span class="line"> </span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.text.DecimalFormat;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">//支付宝网页支付</span><br><span class="line">public class AliWebPayStrategy implements IPayStrategy &#123;</span><br><span class="line"> </span><br><span class="line">    private String url;</span><br><span class="line">    private String appId;</span><br><span class="line">    private String privateKey;</span><br><span class="line">    private String publicKey;</span><br><span class="line">    private int orderTimeOut;</span><br><span class="line"></span><br><span class="line">    public AliWebPayStrategy(String url, String appId, String privateKey, String publicKey, int orderTimeOUt) &#123;</span><br><span class="line">        this.url = url;</span><br><span class="line">        this.appId = appId;</span><br><span class="line">        this.privateKey = privateKey;</span><br><span class="line">        this.publicKey = publicKey;</span><br><span class="line">        this.orderTimeOut = orderTimeOUt;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) throws AlipayApiException &#123;</span><br><span class="line">        Map&lt;String,String&gt; resultMap = new HashMap&lt;&gt;();</span><br><span class="line">        //创建API对应的request</span><br><span class="line">        AlipayTradeWapPayRequest alipayRequest = new AlipayTradeWapPayRequest();</span><br><span class="line">        //支付完成阿里回跳转到该页面</span><br><span class="line">        alipayRequest.setReturnUrl(payBaseModel.getReturnUrl());</span><br><span class="line">        //判断传入的地址是否为http或者https开头  支付结果通知接口</span><br><span class="line">        alipayRequest.setNotifyUrl(payBaseModel.getNotifyUrl());</span><br><span class="line">        JSONObject json = new JSONObject();</span><br><span class="line">        json.put(&quot;out_trade_no&quot;, payBaseModel.getOutTradeNo());</span><br><span class="line">        json.put(&quot;total_amount&quot;, new DecimalFormat(&quot;0.00&quot;).format(new BigDecimal(payBaseModel.getTradeMoney())));</span><br><span class="line">        json.put(&quot;subject&quot;, payBaseModel.getTitle());</span><br><span class="line">        json.put(&quot;passback_params&quot;, payBaseModel.getAttach());</span><br><span class="line">        json.put(&quot;product_code&quot;, &quot;QUICK_WAP_PAY&quot;);</span><br><span class="line">        json.put(&quot;timeout_express&quot;,this.orderTimeOut+&quot;&quot;);</span><br><span class="line">        //填充业务参数</span><br><span class="line">        alipayRequest.setBizContent(json.toJSONString());</span><br><span class="line">        String form = &quot;&quot;;</span><br><span class="line">        AlipayClient alipayClient = new DefaultAlipayClient(this.url, this.appId,this.privateKey, </span><br><span class="line">                PayConstant.ALI_DEFAULT_FORMAT, PayConstant.DEFAULT_CHARSET, this.publicKey, PayConstant.ALI_DEFAULT_SIGNTYPE);</span><br><span class="line">        //调用SDK生成表单</span><br><span class="line">        form = alipayClient.pageExecute(alipayRequest).getBody();</span><br><span class="line">        resultMap.put(&quot;form&quot;,form);</span><br><span class="line">        return resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="WxAppPayStrategy"><a href="#WxAppPayStrategy" class="headerlink" title="WxAppPayStrategy"></a>WxAppPayStrategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.wxpay.sdk.WXPayConstants;</span><br><span class="line"><span class="keyword">import</span> com.github.wxpay.sdk.WXPayUtil;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.http.ContentTypeEnum;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.IPayStrategy;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.PayUtil;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.model.PayBaseModel;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//微信APP支付</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxAppPayStrategy</span> <span class="keyword">implements</span> <span class="title">IPayStrategy</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String mchId;</span><br><span class="line">    <span class="keyword">private</span> String appKey;</span><br><span class="line">    <span class="keyword">private</span> String partnerId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderTimeOut;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WxAppPayStrategy</span><span class="params">(String url, String appId, String mchId, String appKey, String partnerId, <span class="keyword">int</span> orderTimeOut)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.appId = appId;</span><br><span class="line">        <span class="keyword">this</span>.mchId = mchId;</span><br><span class="line">        <span class="keyword">this</span>.appKey = appKey;</span><br><span class="line">        <span class="keyword">this</span>.partnerId = partnerId;</span><br><span class="line">        <span class="keyword">this</span>.orderTimeOut = orderTimeOut;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(WxAppPayStrategy.class);</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">excutePayOrder</span><span class="params">(PayBaseModel payBaseModel)</span> </span>&#123;</span><br><span class="line">        LOGGER.info(<span class="string">"**********************获取微信APP支付模板"</span> + payBaseModel.toString() + </span><br><span class="line">                <span class="string">"**************************************************"</span>);</span><br><span class="line">        Map&lt;String, String&gt; resultMap = <span class="keyword">null</span>;</span><br><span class="line">       </span><br><span class="line">            <span class="comment">//返回结果</span></span><br><span class="line">            resultMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        1 拼接参数向微信请求，获取prepare_id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">            Map&lt;String, String&gt; paramMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            paramMap.put(<span class="string">"appid"</span>, <span class="keyword">this</span>.appId);</span><br><span class="line">            paramMap.put(<span class="string">"body"</span>, payBaseModel.getTitle());</span><br><span class="line">            paramMap.put(<span class="string">"mch_id"</span>, <span class="keyword">this</span>.mchId);</span><br><span class="line">            <span class="comment">//后面返回给app时的nonceStr需要与这里的一致</span></span><br><span class="line">            String nonceStr = WXPayUtil.generateNonceStr();</span><br><span class="line">            paramMap.put(<span class="string">"nonce_str"</span>, nonceStr);</span><br><span class="line">            paramMap.put(<span class="string">"sign_type"</span>, WXPayConstants.MD5);</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(payBaseModel.getAttach())) &#123;</span><br><span class="line">                paramMap.put(<span class="string">"attach"</span>, payBaseModel.getAttach());</span><br><span class="line">            &#125;</span><br><span class="line">            paramMap.put(<span class="string">"out_trade_no"</span>, payBaseModel.getOutTradeNo());</span><br><span class="line">            <span class="comment">//微信支付必须乘以100</span></span><br><span class="line">            paramMap.put(<span class="string">"total_fee"</span>, <span class="keyword">new</span> BigDecimal(payBaseModel.getTradeMoney()).multiply(<span class="keyword">new</span> BigDecimal(<span class="string">"100"</span>)).intValue() + <span class="string">""</span>);</span><br><span class="line">            <span class="comment">//获取用户真实ip</span></span><br><span class="line">            paramMap.put(<span class="string">"spbill_create_ip"</span>, payBaseModel.getRealIp());</span><br><span class="line">            Date currDate = <span class="keyword">new</span> Date();</span><br><span class="line">            <span class="comment">//订单生成时间</span></span><br><span class="line">            paramMap.put(<span class="string">"time_start"</span>, DateUtil.formatDate(currDate, <span class="string">"yyyyMMddHHmmss"</span>));</span><br><span class="line">            <span class="comment">//订单失效时间</span></span><br><span class="line">            paramMap.put(<span class="string">"time_expire"</span>, DateUtil.formatDate(DateUtil.addDate(currDate, Calendar.MINUTE, <span class="keyword">this</span>.orderTimeOut), </span><br><span class="line">                    <span class="string">"yyyyMMddHHmmss"</span>));</span><br><span class="line">            <span class="comment">//异步回调</span></span><br><span class="line">            paramMap.put(<span class="string">"notify_url"</span>, payBaseModel.getNotifyUrl());</span><br><span class="line">            <span class="comment">//支付类型</span></span><br><span class="line">            <span class="comment">//app支付</span></span><br><span class="line">            paramMap.put(<span class="string">"trade_type"</span>, <span class="string">"APP"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            paramMap.put(<span class="string">"sign"</span>, WXPayUtil.generateSignature(paramMap, <span class="keyword">this</span>.appKey, WXPayConstants.SignType.MD5));</span><br><span class="line">            LOGGER.info(<span class="string">"**********************微信支付参数集合:"</span> + paramMap + <span class="string">"**************************************************"</span>);</span><br><span class="line">            String xmlString = WXPayUtil.mapToXml(paramMap);</span><br><span class="line">            String entityString = PayUtil.post(<span class="keyword">this</span>.url,xmlString,ContentTypeEnum.TextXml.getContentType());</span><br><span class="line">            LOGGER.info(<span class="string">"**********************微信支付统一下单接口返回数据:"</span> + entityString + <span class="string">"**************************************************"</span>);</span><br><span class="line">            Map&lt;String, String&gt; wxXmlMap = WXPayUtil.xmlToMap(entityString);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                2  此处组装返回给前端的参数集合</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">            <span class="comment">//组装返回给前端的数据</span></span><br><span class="line">            <span class="comment">//app支付   服务端返回App所需数据</span></span><br><span class="line">            resultMap.put(<span class="string">"appid"</span>, <span class="keyword">this</span>.appId);</span><br><span class="line">            resultMap.put(<span class="string">"noncestr"</span>, nonceStr);</span><br><span class="line">            resultMap.put(<span class="string">"partnerid"</span>, <span class="keyword">this</span>.partnerId);</span><br><span class="line">            resultMap.put(<span class="string">"prepayid"</span>, wxXmlMap.get(<span class="string">"prepay_id"</span>));</span><br><span class="line">            <span class="comment">//官方暂时规定为固定值</span></span><br><span class="line">            resultMap.put(<span class="string">"package"</span>, <span class="string">"Sign=WXPay"</span>);</span><br><span class="line">            resultMap.put(<span class="string">"timestamp"</span>, System.currentTimeMillis() / <span class="number">1000</span> + <span class="string">""</span>);</span><br><span class="line">            <span class="comment">//再次生成签名</span></span><br><span class="line">            resultMap.put(<span class="string">"sign"</span>, WXPayUtil.generateSignature(resultMap, <span class="keyword">this</span>.appKey, WXPayConstants.SignType.MD5));</span><br><span class="line">            resultMap.put(<span class="string">"out_trade_no"</span>, payBaseModel.getOutTradeNo());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"\n********************请求微信统一下单接口异常********************"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="WxWebPayStrategy"><a href="#WxWebPayStrategy" class="headerlink" title="WxWebPayStrategy"></a>WxWebPayStrategy</h3><p>由于微信小程序支付的请求逻辑和公众号内支付基本一致，唯一不同的就是appid和appSecret不同(appSecret用于公众号内和小程序内或者用户的openId，即使同一商家，公众号和小程序的appID和appSecret也不一致，而由此获得的同一个用户的openID也不一致），因此可以和公众号内使用相同的逻辑。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.wxpay.sdk.WXPayConstants;</span><br><span class="line"><span class="keyword">import</span> com.github.wxpay.sdk.WXPayUtil;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.http.ContentTypeEnum;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.IPayStrategy;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.PayConstant;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.PayUtil;</span><br><span class="line"><span class="keyword">import</span> com.tubitu.util.pay.model.PayBaseModel;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//微信公众号/网页支付</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxWebPayStrategy</span> <span class="keyword">implements</span> <span class="title">IPayStrategy</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String mchId;</span><br><span class="line">    <span class="keyword">private</span> String appKey;</span><br><span class="line">    <span class="keyword">private</span> String openId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderTimeOut;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WxWebPayStrategy</span><span class="params">(String url, String appId, String mchId, String appKey, String openId, <span class="keyword">int</span> orderTimeOut)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.appId = appId;</span><br><span class="line">        <span class="keyword">this</span>.mchId = mchId;</span><br><span class="line">        <span class="keyword">this</span>.appKey = appKey;</span><br><span class="line">        <span class="keyword">this</span>.openId = openId;</span><br><span class="line">        <span class="keyword">this</span>.orderTimeOut = orderTimeOut;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(WxWebPayStrategy.class);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">excutePayOrder</span><span class="params">(PayBaseModel payBaseModel)</span> </span>&#123;</span><br><span class="line">        LOGGER.debug(<span class="string">"\n********************微信网页支付参数\n"</span> + payBaseModel.toString() + <span class="string">"\n********************"</span>);</span><br><span class="line">        Map&lt;String, String&gt; resultMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Map&lt;String, String&gt; preParamMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        String nonceStr = WXPayUtil.generateNonceStr();</span><br><span class="line">        preParamMap.put(<span class="string">"appid"</span>, <span class="keyword">this</span>.appId);</span><br><span class="line">        preParamMap.put(<span class="string">"mch_id"</span>, <span class="keyword">this</span>.mchId);</span><br><span class="line">        preParamMap.put(<span class="string">"nonce_str"</span>, nonceStr);</span><br><span class="line">        preParamMap.put(<span class="string">"body"</span>, payBaseModel.getTitle());</span><br><span class="line">        preParamMap.put(<span class="string">"out_trade_no"</span>, payBaseModel.getOutTradeNo());</span><br><span class="line">        Date currDate = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="comment">//订单生成时间</span></span><br><span class="line">        preParamMap.put(<span class="string">"time_start"</span>, DateUtil.formatDate(currDate, <span class="string">"yyyyMMddHHmmss"</span>));</span><br><span class="line">        <span class="comment">//订单失效时间</span></span><br><span class="line">        preParamMap.put(<span class="string">"time_expire"</span>, DateUtil.formatDate(DateUtil.addDate(currDate, Calendar.MINUTE, <span class="keyword">this</span>.orderTimeOut),</span><br><span class="line">                <span class="string">"yyyyMMddHHmmss"</span>));</span><br><span class="line">        preParamMap.put(<span class="string">"total_fee"</span>, <span class="keyword">new</span> BigDecimal(payBaseModel.getTradeMoney()).multiply(<span class="keyword">new</span> BigDecimal(<span class="string">"100"</span>)).intValue() + <span class="string">""</span>);</span><br><span class="line">        preParamMap.put(<span class="string">"spbill_create_ip"</span>, payBaseModel.getRealIp());</span><br><span class="line">        LOGGER.debug(<span class="string">"************************spbill_create_ip"</span> + preParamMap.get(<span class="string">"spbill_create_ip"</span>) + <span class="string">"************************************"</span>);</span><br><span class="line">        preParamMap.put(<span class="string">"notify_url"</span>, payBaseModel.getNotifyUrl());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(payBaseModel.getAttach())) &#123;</span><br><span class="line">            preParamMap.put(<span class="string">"attach"</span>, payBaseModel.getAttach());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(<span class="keyword">this</span>.openId)) &#123;</span><br><span class="line">            <span class="comment">//公众号支付 或者 小程序</span></span><br><span class="line">            preParamMap.put(<span class="string">"openid"</span>, <span class="keyword">this</span>.openId);</span><br><span class="line">            preParamMap.put(<span class="string">"trade_type"</span>, <span class="string">"JSAPI"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//h5 页面支付</span></span><br><span class="line">            preParamMap.put(<span class="string">"trade_type"</span>, <span class="string">"MWEB"</span>);</span><br><span class="line">            <span class="comment">//需要注意的是H5 页面支付微信需要下面的场景信息，在最终页面提交支付请求的时候拿此处的referer里的数据与提交状态比对</span></span><br><span class="line">            preParamMap.put(<span class="string">"scene_info"</span>, <span class="string">"&#123;\"h5_info\": &#123;\"type\":\"Wap\",\"wap_url\": "</span> + payBaseModel.getReferer() + <span class="string">","</span> + <span class="string">"\"wap_name\":"</span> + <span class="string">" "</span> + <span class="string">"\"兔比兔\"&#125;&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preParamMap.put(<span class="string">"sign"</span>, WXPayUtil.generateSignature(preParamMap, PayConstant.WX_APP_KEY));</span><br><span class="line">            String entityString = PayUtil.post(<span class="keyword">this</span>.url, WXPayUtil.mapToXml(preParamMap), ContentTypeEnum.TextXml</span><br><span class="line">                    .getContentType());</span><br><span class="line">            Map&lt;String, String&gt; wxXmlMap = WXPayUtil.xmlToMap(entityString);</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    2  此处组装返回给前端的参数集合</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">            LOGGER.debug(<span class="string">"**********************微信支付统一下单接口返回数据:"</span> + wxXmlMap +</span><br><span class="line">                    <span class="string">"**************************************************"</span>);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(<span class="keyword">this</span>.openId)) &#123;</span><br><span class="line">                String mwebUrl = wxXmlMap.get(<span class="string">"mweb_url"</span>) + <span class="string">"&amp;redirect_url="</span> + URLEncoder.encode(payBaseModel.getReturnUrl(),</span><br><span class="line">                        PayConstant.DEFAULT_CHARSET);</span><br><span class="line">                LOGGER.debug(<span class="string">"*****************  mweb_url = "</span> + mwebUrl + <span class="string">" ************************************************"</span>);</span><br><span class="line">                wxXmlMap.put(<span class="string">"mweb_url"</span>, mwebUrl);</span><br><span class="line">                resultMap.putAll(wxXmlMap);</span><br><span class="line">                resultMap.put(<span class="string">"code"</span>, <span class="number">100000</span> + <span class="string">""</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resultMap.put(<span class="string">"appId"</span>, <span class="keyword">this</span>.appId);</span><br><span class="line">                resultMap.put(<span class="string">"timeStamp"</span>, System.currentTimeMillis() / <span class="number">1000</span> + <span class="string">""</span>);</span><br><span class="line">                resultMap.put(<span class="string">"nonceStr"</span>, nonceStr);</span><br><span class="line">                resultMap.put(<span class="string">"package"</span>, <span class="string">"prepay_id="</span> + wxXmlMap.get(<span class="string">"prepay_id"</span>));</span><br><span class="line">                resultMap.put(<span class="string">"signType"</span>, WXPayConstants.MD5);</span><br><span class="line">                resultMap.put(<span class="string">"paySign"</span>, WXPayUtil.generateSignature(resultMap, <span class="keyword">this</span>.appKey));</span><br><span class="line">                resultMap.put(<span class="string">"code"</span>, <span class="number">100000</span> + <span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"\n********************请求微信统一下单接口异常********************"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Http请求"><a href="#Http请求" class="headerlink" title="Http请求"></a>Http请求</h2><p>自己封装的用HttpClient发送Http请求的工具类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, String stringEntity, String ContentType)</span></span>&#123;</span><br><span class="line">    String result = <span class="string">""</span>;</span><br><span class="line">    CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line">    CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        HttpPost httpPost = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line">        RequestConfig requestConfig = RequestConfig.custom().setSocketTimeout(<span class="number">8000</span>).setConnectTimeout(<span class="number">6000</span>).build();</span><br><span class="line">        httpPost.setConfig(requestConfig);</span><br><span class="line">        StringEntity entity = <span class="keyword">new</span> StringEntity(stringEntity, PayConstant.DEFAULT_CHARSET);</span><br><span class="line">        httpPost.addHeader(<span class="string">"Content-Type"</span>, ContentType);</span><br><span class="line">        httpPost.addHeader(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)"</span>);</span><br><span class="line">        httpPost.setEntity(entity);</span><br><span class="line">        response = httpClient.execute(httpPost);</span><br><span class="line">        <span class="comment">//读取响应体转化为字符串  建议：确定目标地址发出有限长度的响应时，使用该方法</span></span><br><span class="line">        HttpEntity responseEntiry = response.getEntity();</span><br><span class="line">        <span class="comment">//不然使用流的方式好些</span></span><br><span class="line">        <span class="comment">/* if (entity != null) &#123;</span></span><br><span class="line"><span class="comment">            InputStream inputStream = entity.getContent();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream));</span></span><br><span class="line"><span class="comment">            String line = "";</span></span><br><span class="line"><span class="comment">            while ((line = bufferedReader.readLine()) != null) &#123;</span></span><br><span class="line"><span class="comment">                System.out.println(line);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">        result = EntityUtils.toString(responseEntiry, PayConstant.DEFAULT_CHARSET);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        LOGGER.error(<span class="string">"\n******************http post error**********************"</span>,e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            httpClient.close();</span><br><span class="line">            response.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"\n********************close httpclient/response error********************"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="策略枚举"><a href="#策略枚举" class="headerlink" title="策略枚举"></a>策略枚举</h2><p>枚举暴露给客户端，以生成不同策略。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> PayAlgorithm &#123;</span><br><span class="line">    <span class="comment">//支付宝客户端</span></span><br><span class="line">    ALI_APP,</span><br><span class="line">    <span class="comment">//支付宝页面端</span></span><br><span class="line">    ALI_WEB,</span><br><span class="line">    <span class="comment">//微信客户端</span></span><br><span class="line">    WX_APP,</span><br><span class="line">    <span class="comment">//微信页面端</span></span><br><span class="line">    WX_WEB,</span><br><span class="line">    <span class="comment">//微信小程序</span></span><br><span class="line">    WX_XCX;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="策略工厂"><a href="#策略工厂" class="headerlink" title="策略工厂"></a>策略工厂</h2><p>工厂创建策略时，需要传入策略所需的一些配置参数，本文中商户只有一个，因此只有一个创建默认商户的支付策略。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//支付工厂类，可以创建默认支付客户端，也可以创建自定义账户客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayFactory</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建默认支付客户端</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IPayStrategy <span class="title">createDefaultTubituStrategy</span><span class="params">(PayAlgorithm algorithm, String openId)</span></span>&#123;</span><br><span class="line">        IPayStrategy iPayStrategy = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (algorithm)&#123;</span><br><span class="line">            <span class="keyword">case</span> ALI_APP:</span><br><span class="line">                iPayStrategy = <span class="keyword">new</span> AliAppPayStrategy(PayConstant.ALI_ORDER_URL,PayConstant.ALI_APP_ID,PayConstant</span><br><span class="line">                        .ALI_PRIVATE_KEY,PayConstant.ALI_PUBLIC_KEY,<span class="number">30</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ALI_WEB:</span><br><span class="line">                iPayStrategy = <span class="keyword">new</span> AliWebPayStrategy(PayConstant.ALI_ORDER_URL,PayConstant.ALI_APP_ID,PayConstant</span><br><span class="line">                        .ALI_PRIVATE_KEY,PayConstant.ALI_PUBLIC_KEY,<span class="number">30</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> WX_APP:</span><br><span class="line">                iPayStrategy = <span class="keyword">new</span> WxAppPayStrategy(PayConstant.WX_UNIFIEDORDER_URL,PayConstant.WX_APP_ID,</span><br><span class="line">                        PayConstant.WX_MCH_ID,PayConstant.WX_APP_KEY,PayConstant.WX_PARTNER_ID,<span class="number">30</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> WX_WEB:</span><br><span class="line">                iPayStrategy = <span class="keyword">new</span> WxWebPayStrategy(PayConstant.WX_UNIFIEDORDER_URL,PayConstant.WX_H5_APPID,</span><br><span class="line">                        PayConstant.WX_H5_MCHID,PayConstant.WX_APP_KEY,openId,<span class="number">30</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> WX_XCX:</span><br><span class="line">                iPayStrategy = <span class="keyword">new</span> WxWebPayStrategy(PayConstant.WX_UNIFIEDORDER_URL,PayConstant.WX_XCX_APPID,</span><br><span class="line">                        PayConstant.WX_H5_MCHID,PayConstant.WX_APP_KEY,openId,<span class="number">30</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> iPayStrategy;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="场景调用"><a href="#场景调用" class="headerlink" title="场景调用"></a>场景调用</h2><p>首先通过工厂创建指定策略，然后执行接口里的方法，Java能够动态绑定对应实现类。<br>以下代码适用于在controller里调用策略返回支付参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IPayStrategy strategy = PayFactory.createDefaultTubituStrategy(PayAlgorithm.WX_WEB,&quot;&quot;);</span><br><span class="line">PayBaseModel payBaseModel = new PayBaseModel(商品描述,回调接口,交易金额,商户订单编号,支付完跳转页面);</span><br><span class="line">Map&lt;String,String&gt; resultMap = strategy.excutePayOrder(payBaseModel);</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是，小程序支付和公众号内支付需要首先获取openId，所以中间需要一系列重定向和参数。<br><img src="/2018/12/24/pay/2.jpg" alt=""></p>
<p>由于设置<code>redirect_url</code>后,回跳指定页面的操作可能发生在：</p>
<ol>
<li>微信支付中间页调起微信收银台后超过5秒</li>
<li>用户点击“取消支付“或支付完成后点“完成”按钮。因此无法保证页面回跳时，支付流程已结束，所以商户设置的redirect_url地址不能自动执行查单操作，应让用户去点击按钮触发查单操作。</li>
</ol>
<h1 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h1><h2 id="公众号内支付"><a href="#公众号内支付" class="headerlink" title="公众号内支付"></a>公众号内支付</h2><h3 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onBridgeReady</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   WeixinJSBridge.invoke(</span><br><span class="line">      <span class="string">'getBrandWCPayRequest'</span>, &#123;</span><br><span class="line">         <span class="string">"appId"</span>:<span class="string">"wx2421b1c4370ec43b"</span>,     <span class="comment">//公众号名称，由商户传入     </span></span><br><span class="line">         <span class="string">"timeStamp"</span>:<span class="string">"1395712654"</span>,         <span class="comment">//时间戳，自1970年以来的秒数     </span></span><br><span class="line">         <span class="string">"nonceStr"</span>:<span class="string">"e61463f8efa94090b1f366cccfbbb444"</span>, <span class="comment">//随机串     </span></span><br><span class="line">         <span class="string">"package"</span>:<span class="string">"prepay_id=u802345jgfjsdfgsdg888"</span>,     </span><br><span class="line">         <span class="string">"signType"</span>:<span class="string">"MD5"</span>,         <span class="comment">//微信签名方式：     </span></span><br><span class="line">         <span class="string">"paySign"</span>:<span class="string">"70EA570631E4BB79628FBCA90534C63FF7FADD89"</span> <span class="comment">//微信签名 </span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(res.err_msg == <span class="string">"get_brand_wcpay_request:ok"</span> )&#123;</span><br><span class="line">      <span class="comment">// 使用以上方式判断前端返回,微信团队郑重提示：</span></span><br><span class="line">            <span class="comment">//res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。</span></span><br><span class="line">            <span class="comment">//此处可看作支付可能成功，跳转到成功页面</span></span><br><span class="line">            <span class="built_in">window</span>.location.replace(<span class="string">"index.html"</span>);</span><br><span class="line">      &#125; </span><br><span class="line">   &#125;); </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> WeixinJSBridge == <span class="string">"undefined"</span>)&#123;</span><br><span class="line">   <span class="keyword">if</span>( <span class="built_in">document</span>.addEventListener )&#123;</span><br><span class="line">       <span class="built_in">document</span>.addEventListener(<span class="string">'WeixinJSBridgeReady'</span>, onBridgeReady, <span class="literal">false</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">document</span>.attachEvent)&#123;</span><br><span class="line">       <span class="built_in">document</span>.attachEvent(<span class="string">'WeixinJSBridgeReady'</span>, onBridgeReady); </span><br><span class="line">       <span class="built_in">document</span>.attachEvent(<span class="string">'onWeixinJSBridgeReady'</span>, onBridgeReady);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   onBridgeReady();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">wx.config(&#123;</span><br><span class="line">    debug: <span class="literal">true</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></span><br><span class="line">    appId: <span class="string">''</span>, <span class="comment">// 必填，企业号的唯一标识，此处填写企业号corpid</span></span><br><span class="line">    timestamp: , <span class="comment">// 必填，生成签名的时间戳</span></span><br><span class="line">    nonceStr: <span class="string">''</span>, <span class="comment">// 必填，生成签名的随机串</span></span><br><span class="line">    signature: <span class="string">''</span>,<span class="comment">// 必填，签名，见附录1</span></span><br><span class="line">    jsApiList: [] <span class="comment">// 必填，需要使用的JS接口列表，所有JS接口列表见附录2</span></span><br><span class="line">&#125;);</span><br><span class="line">wx.ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。</span></span><br><span class="line">&#125;);</span><br><span class="line">wx.chooseWXPay(&#123;</span><br><span class="line">    appId: <span class="string">'wx23841cce7185b550'</span>,</span><br><span class="line">    timestamp: <span class="string">'1461300911'</span>, <span class="comment">// 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符</span></span><br><span class="line">    nonceStr: <span class="string">'5719aeafb587f'</span>, <span class="comment">// 支付签名随机串，不长于 32 位</span></span><br><span class="line">    package: <span class="string">'prepay_id=wx20160422125512b7d2205c9c0913643939'</span>, <span class="comment">// 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）</span></span><br><span class="line">    signType: <span class="string">'MD5'</span>, <span class="comment">// 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'</span></span><br><span class="line">    paySign: <span class="string">'5DAB1DDABE1AD34E8FF3386AE971B727'</span>, <span class="comment">// 支付签名</span></span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 支付成功后的回调函数</span></span><br><span class="line">    <span class="keyword">if</span> (res.errMsg == <span class="string">"chooseWXPay:ok"</span>) &#123;</span><br><span class="line">    <span class="comment">//支付成功</span></span><br><span class="line">    alert(<span class="string">'支付成功'</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    alert(res.errMsg);</span><br><span class="line">    &#125;</span><br><span class="line">        &#125;,  </span><br><span class="line">    cancel: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//支付取消</span></span><br><span class="line">    alert(<span class="string">'支付取消'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>这里可以看到公众号内支付实际上有两种方式，第一种是jsapi的模式，微信浏览器内部有jsapi直接可以调用，第二种为js-sdk的方式，但是两种方式都需要引入微信的js。<br>http：//res.wx.qq.com/js/jwexin-1.2.0.js</p>
<p>第二种方式可以看到多了一个signature的签名参数，大概提一下如何获取：</p>
<ol>
<li>获取AccessToken</li>
<li>获取jsapi_ticket</li>
<li>生成signature</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//获取微信token</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAccessToken</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取token</span></span><br><span class="line">    String tokenParam = <span class="string">"grant_type=client_credential&amp;appid="</span> + WxPayConfig.APPID + <span class="string">"&amp;secret="</span></span><br><span class="line">            + WxPayConfig.APPSECRET;</span><br><span class="line">    <span class="comment">//这一步的发送请求工具类请自己实现</span></span><br><span class="line">    String tokenJsonStr = HttpUtil.sendGET(<span class="string">"https://api.weixin.qq.com/cgi-bin/token"</span>, tokenParam);</span><br><span class="line">    Map&lt;String,String&gt; tokenMap = JSONObject.fromObject(tokenJsonStr);</span><br><span class="line">    System.out.println(tokenMap);</span><br><span class="line">    <span class="comment">// 获取access_token</span></span><br><span class="line">    String access_token = (String) tokenMap.get(<span class="string">"access_token"</span>);</span><br><span class="line">    <span class="keyword">return</span> access_token;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取jsapi_ticket</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJsApiTicket</span><span class="params">(String accessToken)</span></span>&#123;</span><br><span class="line">    String ticketParam = <span class="string">"access_token="</span> + accessToken + <span class="string">"&amp;type=jsapi"</span>;</span><br><span class="line">    String ticketJsonStr = HttpUtil.sendGET(<span class="string">"https://api.weixin.qq.com/cgi-bin/ticket/getticket"</span>, ticketParam);</span><br><span class="line">    Map&lt;String,String&gt; ticketMap = JSONObject.fromObject(ticketJsonStr);</span><br><span class="line">    <span class="comment">// 获取jsapi_ticket</span></span><br><span class="line">    String ticket = (String) ticketMap.get(<span class="string">"ticket"</span>);</span><br><span class="line">    <span class="keyword">return</span> ticket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//生成signature</span></span><br><span class="line">String url = PayConstant.PAY_DOMAIN;<span class="comment">//微信授权的网址 这个要看微信公众号设置</span></span><br><span class="line">String signValue = <span class="string">"jsapi_ticket="</span> + ticket + <span class="string">"&amp;noncestr="</span> + noncestr + <span class="string">"×tamp="</span> + timestamp</span><br><span class="line">            + <span class="string">"&amp;url="</span> + url;</span><br><span class="line">String signature = Sha1Util.getSha1((signValue))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getSha1</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">char</span> hexDigits[] = &#123;<span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>&#125;;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		MessageDigest mdTemp = MessageDigest.getInstance(<span class="string">"SHA1"</span>);</span><br><span class="line">		mdTemp.update(str.getBytes(<span class="string">"GBK"</span>));</span><br><span class="line">		<span class="keyword">byte</span>[] md = mdTemp.digest();</span><br><span class="line">		<span class="keyword">int</span> j = md.length;</span><br><span class="line">		<span class="keyword">char</span> buf[] = <span class="keyword">new</span> <span class="keyword">char</span>[j * <span class="number">2</span>];</span><br><span class="line">		<span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; j; i++) &#123;</span><br><span class="line">			<span class="keyword">byte</span> byte0 = md[i];</span><br><span class="line">			buf[k++] = hexDigits[byte0 &gt;&gt;&gt; <span class="number">4</span> &amp; <span class="number">0xf</span>];</span><br><span class="line">			buf[k++] = hexDigits[byte0 &amp; <span class="number">0xf</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> String(buf);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理微信回调请求</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">resolveWXPayResponse</span><span class="params">(HttpServletRequest request, String appkey)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    LOGGER.info(<span class="string">"***************************************处理微信回调request域********************************************"</span>);</span><br><span class="line">    ByteArrayOutputStream outSteam = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    InputStream inStream = request.getInputStream();</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((len = inStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        outSteam.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">    &#125;</span><br><span class="line">    outSteam.close();</span><br><span class="line">    inStream.close();</span><br><span class="line">    String result = <span class="keyword">new</span> String(outSteam.toByteArray(), PayConstant.DEFAULT_CHARSET);</span><br><span class="line">    LOGGER.info(<span class="string">"***************************************微信返回结果"</span> + result + <span class="string">"********************************************"</span>);</span><br><span class="line">    Map&lt;String, String&gt; resultMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(result)) &#123;</span><br><span class="line">        Map&lt;String, String&gt; map = WXPayUtil.xmlToMap(result);</span><br><span class="line">        <span class="comment">//验签</span></span><br><span class="line">        <span class="keyword">if</span> (WXPayUtil.isSignatureValid(map, appkey, WXPayConstants.SignType.MD5)) &#123;</span><br><span class="line">            String attach = map.get(<span class="string">"attach"</span>);</span><br><span class="line">            LOGGER.info(<span class="string">"***************************************微信自定义参数"</span> + attach + <span class="string">"********************************************"</span>);</span><br><span class="line">            LOGGER.info(<span class="string">"***************************************商户订单号    ："</span> + map.get(<span class="string">"out_trade_no"</span>) + <span class="string">"********************************************"</span>);</span><br><span class="line">            resultMap = map;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resultMap.put(<span class="string">"return_code"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">            resultMap.put(<span class="string">"return_msg"</span>, <span class="string">"验签失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理支付宝回调请求</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">resolveAliPayResponse</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> UnsupportedEncodingException, AlipayApiException </span>&#123;</span><br><span class="line">    Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap();</span><br><span class="line">    LOGGER.info(<span class="string">"***************************************处理支付宝回调request域********************************************"</span>);</span><br><span class="line">    <span class="comment">//1.从支付宝回调的request域中取值</span></span><br><span class="line">    Map&lt;String, String[]&gt; requestParams = request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> (Iterator&lt;String&gt; iter = requestParams.keySet().iterator(); iter.hasNext(); ) &#123;</span><br><span class="line">        String name = iter.next();</span><br><span class="line">        String[] values = requestParams.get(name);</span><br><span class="line">        String valueStr = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i] : valueStr + values[i] + <span class="string">","</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result.put(name, valueStr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.签名验证(对支付宝返回的数据验证，确定是支付宝返回的)</span></span><br><span class="line">    <span class="keyword">boolean</span> signVerified;</span><br><span class="line">    <span class="comment">//2.1调用SDK验证签名</span></span><br><span class="line">    signVerified = AlipaySignature.rsaCheckV1(result, PayConstant.ALI_PUBLIC_KEY, PayConstant.DEFAULT_CHARSET, PayConstant.ALI_DEFAULT_SIGNTYPE);</span><br><span class="line">    <span class="keyword">if</span> (signVerified) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于设置<code>redirect_url</code>后，回跳指定页面的操作可能发生在：</p>
<ol>
<li>微信支付中间页调起微信收银台后超过5秒</li>
<li>用户点击“取消支付“或支付完成后点“完成”按钮。因此无法保证页面回跳时，支付流程已结束，所以商户设置的redirect_url地址不能自动执行查单操作，应让用户去点击按钮触发查单操作</li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/pay/" rel="tag"># pay</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/21/Hashtable/" rel="next" title="Hashtable">
                <i class="fa fa-chevron-left"></i> Hashtable
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/25/git/" rel="prev" title="git">
                git <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">王靖尧</p>
              <div class="site-description motion-element" itemprop="description">一晃而过的时间，都做了些什么</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">99</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#设计思路"><span class="nav-number">1.</span> <span class="nav-text">设计思路</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#maven依赖"><span class="nav-number">2.</span> <span class="nav-text">maven依赖</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关键类"><span class="nav-number">3.</span> <span class="nav-text">关键类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#策略接口"><span class="nav-number">3.1.</span> <span class="nav-text">策略接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#业务参数类"><span class="nav-number">3.2.</span> <span class="nav-text">业务参数类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四种支付策略"><span class="nav-number">3.3.</span> <span class="nav-text">四种支付策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AliAppPayStrategy"><span class="nav-number">3.3.1.</span> <span class="nav-text">AliAppPayStrategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AliWebPayStrategy"><span class="nav-number">3.3.2.</span> <span class="nav-text">AliWebPayStrategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WxAppPayStrategy"><span class="nav-number">3.3.3.</span> <span class="nav-text">WxAppPayStrategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WxWebPayStrategy"><span class="nav-number">3.3.4.</span> <span class="nav-text">WxWebPayStrategy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http请求"><span class="nav-number">3.4.</span> <span class="nav-text">Http请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#策略枚举"><span class="nav-number">3.5.</span> <span class="nav-text">策略枚举</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#策略工厂"><span class="nav-number">3.6.</span> <span class="nav-text">策略工厂</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#场景调用"><span class="nav-number">3.7.</span> <span class="nav-text">场景调用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#前端代码"><span class="nav-number">4.</span> <span class="nav-text">前端代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#公众号内支付"><span class="nav-number">4.1.</span> <span class="nav-text">公众号内支付</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一种方式"><span class="nav-number">4.1.1.</span> <span class="nav-text">第一种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二种方式"><span class="nav-number">4.1.2.</span> <span class="nav-text">第二种方式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#回调函数"><span class="nav-number">5.</span> <span class="nav-text">回调函数</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王靖尧</span>

  

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>




  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  


  


  



  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/algolia-search.js?v=7.1.0"></script>



  
  
  <script>
    
    function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1 }))
                .done(function() {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function() {
                  console.log('Failed to create');
                });
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + 'DFKH5YVSHsNt0wDOVISahMVx-gzGzoHsz')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': 'DFKH5YVSHsNt0wDOVISahMVx-gzGzoHsz',
                'X-LC-Key': 'ILHc2Y6O0p9xfqi3iAWMwnuv',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });
  </script>



  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
